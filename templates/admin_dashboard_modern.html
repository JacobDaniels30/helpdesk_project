<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Help Desk</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin-modern.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="admin-container">
        <!-- Header -->
        <header class="admin-header">
            <h1 class="admin-title">
                <i class="fas fa-tachometer-alt"></i>
                Admin Dashboard
            </h1>
            <div>
                <a href="{{ url_for('register_agent') }}" class="btn btn-primary">
                    <i class="fas fa-user-plus"></i> Add Agent
                </a>
            </div>
        </header>

        <!-- Dashboard Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ tickets|selectattr("status", "ne", "Resolved")|selectattr("status", "ne", "Closed")|list|length }}</div>
                <div class="stat-label">Active Tickets</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ tickets|selectattr("status", "in", ["Resolved", "Closed"])|list|length }}</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ agents|length }}</div>
                <div class="stat-label">Total Agents</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ tickets|length }}</div>
                <div class="stat-label">Total Tickets</div>
            </div>
        </div>

        <!-- SLA Summary -->
        <div class="stats-grid">
            <div class="stat-card sla-critical">
                <div class="stat-number">{{ sla_summary.resolution_breaches }}</div>
                <div class="stat-label">Resolution Overdue</div>
            </div>
            <div class="stat-card sla-high">
                <div class="stat-number">{{ sla_summary.response_breaches }}</div>
                <div class="stat-label">Response Overdue</div>
            </div>
            <div class="stat-card sla-high">
                <div class="stat-number">{{ tickets|selectattr("severity", "eq", "high")|list|length }}</div>
                <div class="stat-label">High Priority</div>
            </div>
            <div class="stat-card sla-critical">
                <div class="stat-number">{{ tickets|selectattr("severity", "eq", "critical")|list|length }}</div>
                <div class="stat-label">Critical Priority</div>
            </div>
        </div>

        <!-- Category Filter -->
        <section class="tickets-section">
            <h2 class="section-title"><i class="fas fa-filter"></i> Filter by Category</h2>
            <div class="category-filters">
                <a href="{{ url_for('admin_dashboard') }}" class="category-badge" style="background-color: #6c757d;">
                    <i class="fas fa-list"></i> All Categories
                </a>
                {% set categories = tickets|map(attribute='category_name')|unique|list %}
                {% for category in categories %}
                    {% if category %}
                    {% set first_ticket = tickets|selectattr('category_name', 'equalto', category)|list|first %}
                    <a href="{{ url_for('admin_dashboard') }}?category={{ category|urlencode }}"
                       class="category-badge"
                       style="background-color: {{ first_ticket.category_color if first_ticket and first_ticket.category_color else '#6c757d' }};">
                        <i class="fas fa-tag"></i> {{ category }}
                    </a>
                    {% endif %}
                {% endfor %}
            </div>
        </section>

        {% set selected_category = request.args.get('category') %}

        <!-- Active Tickets -->
        <section class="tickets-section">
            <h2 class="section-title"><i class="fas fa-clock"></i> Active Tickets</h2>
            <div class="tickets-grid">
                {% set active_tickets = tickets|selectattr("status", "ne", "Resolved")|selectattr("status", "ne", "Closed")|list %}
                {% if active_tickets %}
                    {% for ticket in active_tickets %}
                        {% if not selected_category or ticket.category_name == selected_category %}
                        <div class="ticket-card">
                            <div class="ticket-header">
                                <span class="ticket-id">#{{ ticket.id }}</span>
                                <span class="badge badge-status">{{ ticket.status }}</span>
                            </div>
                            <h3 class="ticket-title">{{ ticket.title }}</h3>
                            <p class="ticket-description">{{ ticket.description[:100] }}{% if ticket.description|length > 100 %}...{% endif %}</p>
                            <div class="ticket-meta">
                                <span class="ticket-user"><i class="fas fa-user"></i> {{ ticket.user_name }}</span>
                                <span class="ticket-date"><i class="fas fa-calendar"></i> {{ format_date(ticket.created_at_dt, '%Y-%m-%d') }}</span>
                            </div>
                            <div class="ticket-meta">
                                <span class="badge badge-urgency-{{ ticket.urgency|lower|trim }}"><i class="fas fa-exclamation-triangle"></i> {{ ticket.urgency }}</span>
                                <span class="badge category-badge" style="background-color: {{ ticket.category_color or '#6c757d' }};"><i class="fas fa-tag"></i> {{ ticket.category_name or 'Other' }}</span>
                                <span>{% if ticket.assigned_agent_name %}Assigned{% else %}Unassigned{% endif %}</span>
                            </div>
                        <a href="{{ url_for('edit_ticket', ticket_id=ticket.id) }}" class="btn btn-primary">
                            <i class="fas fa-eye"></i> View
                        </a>
                        </div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <div class="empty-state"><i class="fas fa-check-circle"></i><p>No active tickets found.</p></div>
                {% endif %}
            </div>
        </section>

        <!-- Completed Tickets -->
        <section class="tickets-section">
            <h2 class="section-title"><i class="fas fa-check-circle"></i> Completed Tickets</h2>
            <div style="margin-bottom: 20px;">
                <a href="{{ url_for('archived_tickets') }}" class="btn btn-secondary"><i class="fas fa-archive"></i> View Archived Tickets</a>
            </div>
            <div class="tickets-grid">
                {% set completed_tickets = tickets|selectattr("status", "in", ["Resolved", "Closed"])|list %}
                {% if completed_tickets %}
                    {% for ticket in completed_tickets %}
                        {% if not selected_category or ticket.category_name == selected_category %}
                        <div class="ticket-card">
                            <div class="ticket-header">
                                <span class="ticket-id">#{{ ticket.id }}</span>
                                <span class="badge badge-status">{{ ticket.status }}</span>
                            </div>
                            <h3 class="ticket-title">{{ ticket.title }}</h3>
                            <p class="ticket-description">{{ ticket.description[:100] }}{% if ticket.description|length > 100 %}...{% endif %}</p>
                            <div class="ticket-meta">
                                <span class="ticket-user"><i class="fas fa-user"></i> {{ ticket.user_name }}</span>
                                <span class="ticket-date"><i class="fas fa-calendar"></i> {{ format_date(ticket.created_at_dt, '%Y-%m-%d') }}</span>
                            </div>
                            <div class="ticket-meta">
                                <span class="badge badge-urgency-{{ ticket.urgency|lower|trim }}"><i class="fas fa-exclamation-triangle"></i> {{ ticket.urgency }}</span>
                                <span class="badge category-badge" style="background-color: {{ ticket.category_color or '#6c757d' }};"><i class="fas fa-tag"></i> {{ ticket.category_name or 'Other' }}</span>
                                <span>{% if ticket.assigned_agent_name %}Assigned{% else %}Unassigned{% endif %}</span>
                            </div>
                            <div style="margin-top: 15px;">
                                <a href="{{ url_for('edit_ticket', ticket_id=ticket.id) }}" class="btn btn-primary">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                <form method="POST" action="{{ url_for('archive_ticket', ticket_id=ticket.id) }}" style="display: inline; margin-left: 10px;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-secondary" onclick="return confirm('Are you sure you want to archive this ticket?')">
                                        <i class="fas fa-archive"></i> Archive
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <div class="empty-state"><i class="fas fa-inbox"></i><p>No completed tickets found.</p></div>
                {% endif %}
            </div>
        </section>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
</body>
</html>
